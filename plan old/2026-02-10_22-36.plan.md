---
name: ""
overview: ""
todos: []
isProject: false
---

# Plan: Zeitzone Europe/Berlin für Termin- und Datumslogik

**Erstellt:** 2026-02-10  
**Ziel:** Alle Termin-/Datumslogik auf feste Zeitzone Europe/Berlin umstellen, damit Anzeige (Heute/Morgen/Überfällig) und gespeicherte Tages-Termine weltweit konsistent sind.

---

## Konzept

- **Feste Zeitzone weltweit:** Europe/Berlin für alle Termin- und Datumslogik – **unabhängig davon, wo sich das Gerät befindet** (Türkei, USA, Japan, Deutschland, …). Die App nutzt immer Berlin-Zeit, nie die lokale Zeitzone des Handys für Termine/Datum.
- **Interpretation (Lesen/Vergleichen/Anzeigen):** Zeitstempel immer in Berlin interpretieren (Tagesanfang, „heute“, Heute/Morgen, Überfällig).
- **Erzeugen (Speichern):** Wenn der Nutzer einen Tag wählt (z. B. „Mittwoch“), den Zeitstempel so erzeugen, dass er „Mittwoch 00:00 Uhr in Berlin“ bedeutet.
- **Bestehende Long-Werte:** Unverändert lassen; nur die Interpretation erfolgt in Berlin. Keine Migration der Datenbank nötig.

---

## Prioritäten (Reihenfolge der Umsetzung)

1. Zentrale Zeitzone anlegen.
2. TerminBerechnungUtils (Kern: getStartOfDay, „heute“, Wochentag, Monatsgrenzen).
3. DateFormatter (Anzeige, Heute/Morgen, isToday, isPast).
4. Kalender-Dialog (Erzeugen des Zeitstempels beim Tag-Klick).
5. Alle übrigen Stellen (ValidationHelper, TourPlanner, Listen, etc.).
6. Optional: Unit-Tests für getStartOfDay, formatDateRelative, isToday.

---

## Konkrete Schritte

### 1. Zentrale Zeitzone

- **Was:** Eine Konstante oder kleine Util-Klasse für die App-Zeitzone (z. B. `AppTimeZone` = `TimeZone.getTimeZone("Europe/Berlin")`). Kein Code in dieser Plan-Datei; nur festhalten: eine zentrale Stelle, die von allen Datum/ Termin-Stellen genutzt wird.
- **Wo:** Neues Util (z. B. `AppTimeZone.kt` oder Erweiterung in bestehender Util) im passenden Package.
- **Hinweis:** Überall, wo bisher `Calendar.getInstance()` für Termine/Datum/Anzeige genutzt wird, soll künftig `Calendar.getInstance(AppTimeZone)` (bzw. die zentrale Berlin-Zeitzone) verwendet werden.

---

### 2. TerminBerechnungUtils

- **getStartOfDay(timestamp):** Calendar mit Berlin-Zeitzone erzeugen, `timeInMillis = timestamp` setzen, dann H/M/S/MS auf 0 setzen (Tagesanfang in Berlin), `timeInMillis` zurückgeben.
- **Alle weiteren Calendar-Nutzungen in dieser Datei:** Wochentag (`getWochentagForDay`), Monatsgrenzen (`berechneMonatlicheWochentagTermine`), `berechneWiederholendeTermine`, `berechneTermineAusWochentagen`, `naechstesFaelligAmDatum` („heute“ = Start des Tages in Berlin) – überall Berlin-Calendar verwenden.
- **„Heute“:** Wenn „heute“ für Vergleiche gebraucht wird, aus `System.currentTimeMillis()` den Tagesanfang in Berlin berechnen (über getStartOfDay mit Berlin-Calendar).

---

### 3. DateFormatter

- **Alle Überladungen,** die aus `timeInMillis` ein Calendar erzeugen: Calendar mit Berlin-Zeitzone erzeugen, dann `timeInMillis` setzen. Betrifft u. a. formatDate, formatDateWithLeadingZeros, formatTime, formatDateTime, formatDateShort, formatDateWithWeekday, formatDateWithFullWeekday, formatDateRelative, isToday, isTomorrow, isPast.
- **formatDateRelative / Heute-Morgen:** „Heute“ und „Morgen“ sollen den Tag in Berlin bezeichnen; dazu „today“ und „target“ als Berlin-Calendar mit Tagesnormalisierung (00:00:00.000) berechnen.
- **SimpleDateFormat:** Falls verwendet, Zeitzone auf Berlin setzen (setTimeZone), damit Formatierung konsistent ist.

---

### 4. Kalender-Dialog (Termin anlegen)

- **Datei:** `TerminDatumKalenderDialog.kt` (bzw. die Composable, in der der Tag geklickt wird und `onDateSelected(dayMs)` aufgerufen wird).
- **Beim Klick auf einen Tag:** Den Zeitstempel nicht mit `Calendar.getInstance()` (Gerätezeit) erzeugen, sondern mit Calendar in Berlin: Jahr/Monat/Tag aus der Anzeige, dann `set(year, month, day, 0, 0, 0)` und MILLISECOND 0 in Berlin → `timeInMillis` an `onDateSelected` übergeben und speichern.
- **„Heute“-Markierung im Kalender:** `todayStart` mit Berlin-Tagesanfang berechnen (z. B. über TerminBerechnungUtils.getStartOfDay, sobald diese auf Berlin umgestellt ist), damit der hervorgehobene Tag überall derselbe ist.
- **Hilfsfunktionen im Dialog:** z. B. `getDaysInMonth`, `getFirstWeekdayOfMonth` – wenn sie für die Kalenderanzeige (Monat/Jahr) genutzt werden, optional auf Berlin umstellen, damit die Kalenderstruktur (erster Wochentag des Monats) konsistent ist.

---

### 5. Alle übrigen Stellen (Checkliste)

Für jede der folgenden Dateien: Alle Stellen, an denen ein Calendar für **Datum/Termin** erzeugt wird oder „heute“ / „Start des Tages“ berechnet wird, auf die zentrale Berlin-Zeitzone umstellen. Reine „Jetzt“-Zeitstempel (z. B. Erfassungszeit, Logs, Dateinamen) können `System.currentTimeMillis()` bleiben.


| Datei                                                             | Anpassung                                                                                                                             |
| ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| ValidationHelper.kt                                               | „today“ und „target“ für isValidFutureDate (und ggf. weitere Datumsvalidierungen) mit Berlin-Calendar.                                |
| TourPlannerDateUtils.kt                                           | Nutzt getStartOfDay von TerminBerechnungUtils; nach Schritt 2 automatisch Berlin. Prüfen, ob weitere Calendar-Erzeugungen existieren. |
| TourPlannerViewModel.kt                                           | Calendar für Datum/„heute“ (z. B. heuteStart, Anzeige) auf Berlin umstellen.                                                          |
| TourPlannerCoordinator.kt                                         | viewDate-Calendar: bei Nutzung für Termin-Logik Berlin verwenden.                                                                     |
| TourPlannerActivity.kt                                            | Calendar mit timeInMillis für Datum, heuteStart – Berlin.                                                                             |
| TerminCache.kt                                                    | heuteStart über TerminBerechnungUtils (nach Schritt 2); ggf. weitere Calendar-Stellen prüfen.                                         |
| TourPlannerErledigungHandler.kt                                   | heuteStart, „heute“-Vergleiche – Berlin (über Utils bzw. Berlin-Calendar).                                                            |
| ListeBearbeitenCallbacks.kt                                       | Calendar getInstance für Datum/Start des Tages auf Berlin umstellen.                                                                  |
| ListeBearbeitenViewModel.kt                                       | Falls „now“ für Datum-Logik genutzt wird, klären (evtl. nur Erfassungszeit → unverändert).                                            |
| IntervallManager.kt                                               | Calendar für intervall.abholungDatum, auslieferungDatum, initialDatum – Berlin.                                                       |
| TerminRegelManager.kt                                             | Calendar für datum – Berlin.                                                                                                          |
| WochentagBerechnung.kt                                            | Calendar für startDatum – Berlin.                                                                                                     |
| StatisticsViewModel.kt                                            | heute/heuteStart – Berlin.                                                                                                            |
| BelegMonatGrouping.kt                                             | Calendar für datumMs (Monatsgruppierung) – Berlin.                                                                                    |
| UrlaubActivity.kt                                                 | Calendar für von/bis (Termin-/Datumslogik) – Berlin.                                                                                  |
| DialogBaseHelper.kt                                               | initialDate/Calendar für Datumsauswahl – Berlin.                                                                                      |
| CustomerButtonVisibilityHelper.kt                                 | heuteStart, isSameCalendarDay (ms1, ms2) – Berlin-Calendar für Datumsvergleich.                                                       |
| KundenListenViewModel.kt                                          | todayIdx (Wochentag für Listen), erstelltAm – bei Datumsbezug Berlin.                                                                 |
| CustomerDetailViewModel.kt / CustomerDetailScreen.kt              | startDatum, erstelltAm, initialDate – bei Erzeugung/Interpretation von Tagesanfang Berlin.                                            |
| AddCustomerActivity.kt / AddCustomerScreen.kt                     | erstelltAm, startDatum, initialDate – Berlin.                                                                                         |
| AusnahmeTerminActivity.kt                                         | initialDate – Berlin.                                                                                                                 |
| TerminAnlegenUnregelmaessigActivity.kt                            | startDatum – Berlin.                                                                                                                  |
| MainViewModel.kt                                                  | startDatum für Termin-Logik – Berlin.                                                                                                 |
| ListeErstellenViewModel.kt                                        | erstelltAm – bei Datum-Logik Berlin.                                                                                                  |
| AddMonthlyIntervallSheet.kt                                       | erstelltAm – Berlin.                                                                                                                  |
| MapViewViewModel.kt                                               | heuteStart – Berlin.                                                                                                                  |
| CustomerTermFilter.kt                                             | „now“ für isActiveForTerms: wenn als Tagesdatum interpretiert, „Start des Tages Berlin“ nutzen; sonst unverändert.                    |
| TourDataProcessor.kt / TourDataCategorizer.kt / TourDataFilter.kt | getStartOfDay, heuteStart, abDatum – nach Schritt 2 über Utils; eigene Calendar-Erzeugungen auf Berlin prüfen.                        |
| CustomerRepository.kt                                             | Keine Calendar-Erzeugung; ruft TerminBerechnungUtils auf → nach Schritt 2 ok.                                                         |
| SevDeskImport.kt                                                  | erstelltAm mit getStartOfDay – nach Schritt 2 ok.                                                                                     |
| ListeIntervalleMigration.kt                                       | erstelltAm – bei Neuberechnung Berlin nutzen.                                                                                         |
| KundenListeRepository.kt                                          | erstelltAm Fallback „now“ – nur bei Datumslogik Berlin; sonst evtl. unverändert.                                                      |
| TourOrderRepositoryFirebaseImpl.kt                                | Calendar für Datum – Berlin.                                                                                                          |


---

### 6. Optional: Unit-Tests

- **getStartOfDay:** Mit festem Zeitstempel „Mittwoch 00:00 Berlin“ prüfen, dass zurückgegebener Tagesanfang in Berlin liegt und dass derselbe Tag in einer anderen Zeitzone (z. B. Turkey) nicht auf Dienstag kippt (Test mit gesetzter Default-Zeitzone oder expliziter Berlin-Interpretation).
- **formatDateRelative / isToday / isTomorrow:** Mit festem Zeitstempel und festem „heute“ (Berlin) prüfen, dass „Mittwoch 00:00 Berlin“ als „Heute“ bzw. „Morgen“ korrekt ausgegeben wird, unabhängig von der Geräte-Zeitzone (z. B. Test in Turkey vs. Germany simulieren).
- Bestehende Tests in `TerminBerechnungUtilsTest.kt`: anpassen, falls sie aktuell `TimeZone.getDefault()` nutzen; Erwartungen auf Berlin-Interpretation umstellen.

---

## Wichtige Punkte (Regeln)

- **Nur Termin-/Datum-Logik** auf Berlin umstellen; reine Zeitstempel für „Jetzt“ (Erfassungszeit, Logs, Dateinamen) können weiter `System.currentTimeMillis()` bleiben.
- **Bestehende gespeicherte Long-Werte nicht ändern:** Keine Migration; nur die Interpretation (Tagesanfang, Heute/Morgen, Überfällig) erfolgt überall in Berlin.
- **Keine neuen Bugs:** Vor Änderungen Abhängigkeiten prüfen (Regel „Nichts kaputt machen“); Überfällig-Logik und Tour-Planner weiterhin korrekt mit vergangenen Terminen.

---

## Abnahme

- **Weltweit einheitlich:** Egal wo sich das Gerät befindet (Türkei, USA, Japan, Deutschland, …) – es wird immer Berlin-Zeit genutzt. Ein Termin „Mittwoch“ wird überall als Mittwoch angezeigt, nie abweichend wegen lokaler Zeitzone.
- „Heute“ / „Morgen“ / „Überfällig“ sind unabhängig vom Standort des Geräts konsistent (immer Berlin-Tag).
- Bestehende Unit-Tests grün; optionale neuen Zeitzonen-Tests bestanden.

