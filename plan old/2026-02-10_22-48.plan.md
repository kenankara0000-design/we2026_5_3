---
name: ""
overview: ""
todos: []
isProject: false
---

# Plan: Gesamtpreis im BelegeScreen + Erledigt-Button für Belege

**Erstellt:** 2026-02-10 22:48

---

## Übersicht

1. **Gesamtpreis im BelegeScreen anzeigen** – Fix: Preise laden und übergeben (wie in WaschenErfassungActivity).
2. **Erledigt-Button für Belege** – Beleg öffnen → „Erledigt“ klicken → Beleg verriegeln und in Erledigt-Bereich verschieben; offene Belege separat von erledigten, damit nicht alles jedes Mal geladen werden muss.

---

## Teil 1: Gesamtpreis im BelegeScreen

### Problem

BelegeScreen übergibt `preiseGross = emptyMap()` (Zeile 88). BelegeViewModel hat keine Kunden-/Tour-Preis-Repositories.

### Lösung

- **BelegeViewModel:** `KundenPreiseRepository` und `TourPreiseRepository` injizieren.
- **BelegeViewModel:** `_belegPreiseGross: MutableStateFlow<Map<String, Double>>` und beim `openBelegDetail` bzw. `openBelegDetailFromAlle` Preise laden (analog zu `WaschenErfassungViewModel.openBelegDetail`).
- **BelegeScreen:** `belegPreiseGross` aus ViewModel statt `emptyMap()` übergeben.
- **BelegeViewModel:** In `backFromBelegDetail()` `_belegPreiseGross = emptyMap()` setzen.

### Betroffene Dateien

- `BelegeViewModel.kt` – Repositories + Preise laden
- `BelegeScreen.kt` – `preiseGross` aus ViewModel
- `BelegeActivity.kt` – `belegPreiseGross` collectAsState und an Screen übergeben
- `AppModule.kt` – BelegeViewModel-Konstruktor um KundenPreiseRepository, TourPreiseRepository erweitern

---

## Teil 2: Erledigt-Button und Erledigt-Bereich

### Ziel

- Beim Öffnen eines Belegs: Button „Erledigt“ sichtbar.
- Klick → Beleg wird als erledigt markiert (verriegelt).
- Erledigte Belege erscheinen in einem separaten Bereich und werden nicht mehr in der offenen Liste geladen.

### Datenmodell

**Option A (empfohlen): Feld `erledigt` in WaschErfassung**

- `WaschErfassung`: `erledigt: Boolean = false` hinzufügen.
- Beim Klick „Erledigt“: alle Erfassungen des Belegs auf `erledigt = true` setzen (Repository-Update).
- Vorteil: Eine Quelle, einfache Filterung. Rückwärtskompatibel (Default false).

**Option B:** Separater Firebase-Node `belegErledigt` (customerId_monthKey → true). Keine Änderung an WaschErfassung, aber zusätzliche Datenquelle und Join-Logik.

### UI-Struktur

- **Offene Belege:** Nur Erfassungen mit `erledigt == false` → BelegMonatGrouping wie bisher.
- **Erledigt-Bereich:** Tab/Unterseite „Erledigt“, lädt nur Erfassungen mit `erledigt == true`, gruppiert nach Kunde + Monat.
- Beleg-Detail: Button „Erledigt“ (nur bei offenen Belegen). Nach Klick: alle Erfassungen updaten → zurück zur Liste; Beleg erscheint nur noch unter „Erledigt“.

### ErfassungRepository-Änderungen

- `parseErfassung`: Feld `erledigt` lesen (Default false).
- `saveErfassung` / `saveErfassungNew`: `erledigt` mitschreiben.
- `updateErfassungErledigt(erfassungId: String, erledigt: Boolean)` oder
- `markBelegErledigt(erfassungen: List<WaschErfassung>)` – alle Erfassungen im Beleg auf erledigt=true setzen.
- `getErfassungenByCustomerFlow`: optionalen Parameter `includeErledigt: Boolean = false` – bei false nur `erledigt == false` filtern.
- `getErfassungenByCustomerFlowErledigt(customerId)`: nur erledigte.
- `getAllErfassungenFlow`: ebenfalls optional `includeErledigt` oder getrennte Methode für erledigte Belege.

### Betroffene Dateien

- `WaschErfassung.kt` – `erledigt: Boolean = false`
- `ErfassungRepository.kt` – parse/save erledigt, `markBelegErledigt`, Filter in Flows
- `WaschenErfassungBelegDetailContent.kt` – Button „Erledigt“, Callback `onErledigt`
- `WaschenErfassungViewModel.kt` – `markBelegErledigt`, `onErledigt` durchreichen
- `BelegeViewModel.kt` – ebenso
- `WaschenErfassungBelegListeContent.kt` / `WaschenErfassungAlleBelegeContent.kt` – evtl. Tab/Filter „Offen“ vs. „Erledigt“
- Firebase-Struktur: `waschErfassungen/{id}/erledigt` (Boolean)

### Hinweis

- Bestehende Erfassungen ohne `erledigt` gelten als `false` (nicht erledigt).
- Bei „Erledigt“-Klick: Bestätigungsdialog sinnvoll („Beleg als erledigt markieren?“).

---

## Reihenfolge der Umsetzung

1. **Teil 1** – Gesamtpreis (schneller Fix, wenige Dateien).
2. **Teil 2** – Erledigt-Feature (Datenmodell → Repository → UI → Tab/Filter).

---

## Offene Punkte

- Soll der Erledigt-Bereich pro Kunde (BelegListe) und in „Alle Belege“ getrennt sein (z.B. Tabs „Offen“ / „Erledigt“)?
- Soll „Erledigt“ rückgängig gemacht werden können (z.B. erledigt wieder auf false setzen)?

