---
name: ""
overview: ""
todos: []
isProject: false
---

# Plan: Termin-Logik, Kunden-/Ausnahme-Bereiche, Tour-Planner Erledigung

**Erstellt:** 2026-02-09, 09:15  
**Status:** Warte auf Bestätigung vor Codierung

---

## 1. Zusammenfassung der Anforderungen


| Thema                    | Anforderung                                                                                                                                                                                           |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Regelmäßige Termine      | Automatisch erzeugt (unverändert). L = A + Zahl gilt.                                                                                                                                                 |
| Unregelmäßige Termine    | Nur über **Termin Anlegen** (TerminAnlegenUnregelmaessigActivity) anlegen/erzeugen. L = A + Zahl gilt.                                                                                                |
| Kunden-Termine           | Eigenes Segment, **ein- und ausklappbar**. L = A + Zahl. Button-Text: „Abholungstermin hinzufügen“ → **„Neu Termin“**. Datumswahl: **Kalender für ganzes Jahr**. **Löschen nur im Bearbeiten-Modus.** |
| Ausnahme-Termine         | Eigenes Segment, **ein- und ausklappbar**. L = A + Zahl (beim Anlegen eines A-Termins auch L = A + tageAzuL anlegen). **Löschen nur im Bearbeiten-Modus.**                                            |
| Abruf-Termine            | **Unverändert** – keine L = A + Zahl-Logik.                                                                                                                                                           |
| Tour Planner Erledigung  | **Zwei Bereiche:** oben „A und L erledigen“ (Erledigung), unten „Keine Wäsche“ und „Termin verschieben“.                                                                                              |
| Tour Planner Tab         | Tab-Text **„Termin“ → „Termine“**. Unter dem Termine-Tab: **pro Kunde die Termine anzeigen**, in jeder Zeile **A-Termin und daneben L-Termin**.                                                       |
| Erledigt-Bereich (Sheet) | **Max. halber Bildschirm**; Inhalt **scrollbar** (bei vielen erledigten Kunden).                                                                                                                      |


---

## 2. Betroffene Dateien und Änderungen (ohne Reihenfolge)

### 2.1 L = A + Zahl (Bestätigung / ggf. Anpassung)

- **Regelmäßig / Unregelmäßig:** Bereits über `TerminAusKundeUtils`, `TourDataFilter`, `CustomerRepository.addKundenAbholungMitLieferung` (L = A + tageAzuL). Keine Änderung nötig, außer sicherstellen, dass **Ausnahme-Termine** beim Anlegen eines A-Termins automatisch auch L (A + tageAzuL) bekommen.
- **AusnahmeTerminActivity:** Beim Anlegen eines **Ausnahme-A-Termins** wird **L automatisch** mit L = A + tageAzuL angelegt (wie bei Kunden-Terminen). Nutzer wählt nur A; L wird erzeugt.
- **Abruf (Auf Abruf):** Keine Änderung; Abruf-Logik (TerminRegelManager, TourDataFilter etc.) bleibt wie heute.

**Dateien:** `AusnahmeTerminActivity.kt`, ggf. `CustomerRepository.kt` (addAusnahmeTermin erweitern oder neuer Aufruf für A+L).

---

### 2.2 Kunden-Termine: Button „Neu Termin“, Kalender ganzes Jahr, Löschen nur bei Bearbeiten

- **Button-Text:** In `CustomerDetailKundenTermineSection.kt` und überall, wo der Button für Kunden-Termine genutzt wird: `sheet_abholungstermin_hinzufuegen` durch neuen String ersetzen (z. B. `label_neu_termin` = „Neu Termin“).  
**strings.xml:** Neuer Eintrag `label_neu_termin` (oder `btn_neu_termin`), in Kunden-Termine-Section und ggf. ErledigungTabTerminContent nur für diesen Kontext verwenden.
- **Kalender ganzes Jahr:** `AusnahmeTerminActivity` wird für Kunden-Termine mit `EXTRA_ADD_ABHOLUNG_MIT_LIEFERUNG = true` geöffnet. Aktuell: 14-Tage-Liste. **Änderung:** Wenn Kunden-Termin (addAbholungMitLieferung): **Kalender-/DatePicker-UI** für das gesamte Jahr (z. B. Material DatePicker oder Monatsübersicht).  
**Datei:** `AusnahmeTerminActivity.kt` (getrennte UI für „Kunden-Termin“ vs. „Ausnahme-Termin“).
- **Löschen nur über Bearbeiten:**  
  - `CustomerDetailKundenTermineSection`: Parameter `isInEditMode: Boolean` (oder `canDeleteTermin: Boolean`). Delete-Icon/Button nur anzeigen, wenn `isInEditMode == true`.  
  - `CustomerDetailAusnahmeTermineSection`: analog `isInEditMode` / `canDeleteTermin`, Löschen nur im Bearbeiten-Modus.  
  - `CustomerDetailTermineTab` (bzw. Aufrufer) liefert `isInEditMode` an beide Sections.

**Dateien:** `CustomerDetailKundenTermineSection.kt`, `CustomerDetailAusnahmeTermineSection.kt`, `CustomerDetailTermineTab.kt`, `strings.xml`, `AusnahmeTerminActivity.kt`.

---

### 2.3 Kunden-Termine und Ausnahme-Termine: Ein- und ausklappbare Bereiche

- **Kunden-Termine:** Eigenen Bereich beibehalten und **ausklappbar** machen (z. B. `ExpandableSection` oder `Column` mit `ExpandableCard`/`IconButton` zum Umschalten). **Standard: immer eingeklappt** beim Öffnen des Kunden-Details.
- **Ausnahme-Termine:** Eigenen Bereich ebenfalls **ausklappbar** gestalten, gleiches Muster. **Standard: immer eingeklappt** beim Öffnen des Kunden-Details.

**Dateien:** `CustomerDetailKundenTermineSection.kt`, `CustomerDetailAusnahmeTermineSection.kt` (oder gemeinsame `ExpandableSection`-Komponente in `ui/detail` oder `ui/common`).

---

### 2.4 Tour Planner: Erledigung-Tab in zwei Bereiche trennen

- **Erledigung-Tab** enthält **zwei klar getrennte Bereiche:**  
  - **Oben:** A erledigen und L erledigen (plus ggf. Ausnahme-A/L und Rückgängig).  
  - **Unten:** Keine Wäsche und Termin verschieben (Buttons).
- **Termine-Tab** enthält **nur** die Termine des Kunden (A und L), keine Erledigung- oder Aktionen-Buttons hier.

**Dateien:** `ErledigungSheetContent.kt`, `ErledigungTabErledigungContent.kt`, `ErledigungTabTerminContent.kt` – Erledigung-Tab: zwei Bereiche; Termine-Tab: nur Termin-Liste (siehe 2.5).

---

### 2.5 Tour Planner: Tab „Termin“ → „Termine“, Termin-Liste pro Kunde (A | L)

- **Tab-Label:** `sheet_tab_termin` in **strings.xml** von „Termin“ auf **„Termine“** ändern.
- **Button entfernen:** Den Button **„Abholungstermin hinzufügen“** unter dem Termine-Tab **entfernen** (nur noch Termin-Liste anzeigen).
- **Inhalt Termine-Tab:** Nur die **Termine dieses Kunden** anzeigen (A und L). Quelle: `customer.kundenTermine` + `customer.ausnahmeTermine` (+ ggf. berechnete Termine für Kontext).
- **Pro Zeile:** A-Termin und daneben L-Termin. **Wenn nicht aufwändig:** als **A-Badge mit Datum** und **L-Badge mit Datum** darstellen (z. B. kleine Badges/Chips: „A 12.03.“ und „L 19.03.“).

**Dateien:** `ErledigungTabTerminContent.kt` (Button „Abholungstermin hinzufügen“ entfernen; nur Termin-Liste mit A/L pro Zeile, optional A-/L-Badges mit Datum; keine KW/Verschieben-Buttons im Termine-Tab), `strings.xml` (`sheet_tab_termin` → „Termine“).

---

### 2.6 Termin Anlegen (Unregelmäßig): Button „Gewählte Termine anlegen“ auf dem Handy sichtbar

- **Problem:** In `TerminAnlegenUnregelmaessigActivity` wird der Button „Gewählte Termine anlegen“ auf dem Handy nicht angezeigt.
- **Ursache:** Die Liste der Slot-Vorschläge kommt aus `TerminRegelManager.schlageSlotsVor` (Kunde + Tour-Slots + Wochentage; Zeitraum **2 Wochen** bei Auf Abruf/Regelmäßig, **8 Wochen** bei Unregelmäßig). Die UI baut eine **Column** mit Titel, **LazyColumn** (alle Slots) und darunter dem Button. Die Column scrollt nicht; die LazyColumn nimmt ihre volle Inhaltshöhe ein. Auf kleinen Screens liegt der Button **unter dem sichtbaren Bereich** und ist nicht erreichbar.
- **Lösung:** Der Liste den **restlichen Platz** zuweisen (`Modifier.weight(1f)` an der LazyColumn), damit sie nur diesen Bereich belegt und **innerhalb** davon scrollt. Der Button bleibt **immer sichtbar** unter der scrollbaren Liste. Dafür den „else“-Zweig (Titel + Liste + Button) in eine **Column** mit `Modifier.fillMaxSize()` packen und der LazyColumn `Modifier.weight(1f)` geben.

**Datei:** `TerminAnlegenUnregelmaessigActivity.kt`.

---

### 2.7 Tour Planner: Erledigt-Bereich (Sheet) begrenzen und scrollbar

- **Problem:** Wenn viele Kunden erledigt werden, vergrößert sich der **Erledigt**-Bereich (ModalBottomSheet) über den ganzen Bildschirm.
- **Ziel:** Der Erledigt-Sheet soll **maximal bis zur Hälfte des Bildschirms** öffnen; der **Inhalt** (Liste der erledigten Kunden) soll **scrollbar** sein.
- **Umsetzung:** In `TourPlannerErledigtSheet` die Sheet-Höhe begrenzen (z. B. `Modifier.heightIn(max = …)` oder feste max. Höhe z. B. 50 % der Bildschirmhöhe) und den Inhalt in eine scrollbare Liste (z. B. `LazyColumn` oder `Column` mit `verticalScroll`) packen, damit bei vielen Einträgen innerhalb des Bereichs gescrollt werden kann.

**Datei:** `TourPlannerErledigtSheet.kt`.

---

## 3. Klärungen (erledigt)

1. **Ausnahme-Termine A+L:** L-Termine werden beim Anlegen eines Ausnahme-A-Termins **automatisch** mit L = A + tageAzuL erzeugt (wie bei Kunden-Terminen).
2. **Erledigung vs. Termine-Tabs:** **Erledigung-Tab** hat zwei Bereiche: oben A und L erledigen, unten KW- und Verschieben-Buttons. **Termine-Tab:** nur Termine des Kunden (A und L) anzeigen; wenn nicht aufwändig: A-Badge mit Datum, dann L-Badge mit Datum.
3. **Standard-Zustand Kunden-/Ausnahme-Bereiche:** Beim Öffnen des Kunden-Details immer **eingeklappt**.

---

## 4. Reihenfolge (Vorschlag)

1. **Bugfix:** Button „Gewählte Termine anlegen“ in `TerminAnlegenUnregelmaessigActivity` auf dem Handy sichtbar machen (2.6).
2. Strings und kleine UI-Texte („Neu Termin“, „Termine“).
3. Löschen nur bei Bearbeiten (Kunden- und Ausnahme-Sections).
4. Ein-/ausklappbare Sections für Kunden-Termine und Ausnahme-Termine.
5. AusnahmeTerminActivity: Kalender ganzes Jahr für Kunden-Termin; ggf. Ausnahme A+L (L = A + Zahl).
6. Tour Planner: Erledigung zwei Bereiche (oben A/L, unten KW + Verschieben); Tab „Termine“ und Termin-Liste (A | L pro Zeile).
7. Tour Planner: Erledigt-Sheet max. halber Bildschirm, Inhalt scrollbar (2.7).

---

**Bitte bestätigen oder Anpassungen nennen, danach starte ich mit der Codierung.**