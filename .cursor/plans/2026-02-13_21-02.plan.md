---
name: ""
overview: ""
todos: []
isProject: false
---

# Tiefenanalyse & Refactoring-Plan – TourPlaner 2026

**Erstellt:** 2026-02-13 21:02  
**Scope:** Gesamte App – Code, Design, Architektur, Zentralisierung, Kompatibilität  
**Analysierte Dateien:** 229 Kotlin-Dateien, 62 XML-Ressourcen

---

## Inhaltsverzeichnis

1. [Executive Summary](#1-executive-summary)
2. [Activities & Navigation](#2-activities--navigation)
3. [UI/Design-System](#3-uidesign-system)
4. [ViewModels & State Management](#4-viewmodels--state-management)
5. [Repositories & Datenzugriff](#5-repositories--datenzugriff)
6. [Datenmodelle](#6-datenmodelle)
7. [Business-Logik & Utils](#7-business-logik--utils)
8. [Doppelter Code (Duplikate)](#8-doppelter-code-duplikate)
9. [Zentralisierungspotenzial](#9-zentralisierungspotenzial)
10. [Kompatibilität & Dependencies](#10-kompatibilität--dependencies)
11. [Bekannte Konflikte](#11-bekannte-konflikte)
12. [Toter/Alter Code](#12-toteralter-code)
13. [Accessibility](#13-accessibility)
14. [Strings & Lokalisierung](#14-strings--lokalisierung)
15. [Ressourcen (Drawables, Colors, Themes)](#15-ressourcen-drawables-colors-themes)
16. [Positiv-Befunde](#16-positiv-befunde)
17. [Priorisierter Maßnahmenplan](#17-priorisierter-massnahmenplan)

---

## 1. Executive Summary

Die App hat eine **solide Grundarchitektur** (Compose, Koin DI, Firebase RTDB, MVVM). Die Hauptprobleme liegen in:

- **Inkonsistenz** zwischen Screens (Farben, Spacing, Buttons, Fehlerdarstellung)
- **Fehlende Zentralisierung** (kein Design-System, kein BaseViewModel überall genutzt)
- **Gemischte Patterns** (LiveData vs. StateFlow, observeAsState vs. collectAsState)
- **Doppelter Code** in ViewModels (Suche, Preise laden, Ergebnis-Handling)
- **Hardcodierte Werte** (Farben, Strings, Spacing)
- **Große Dateien** (TourDataProcessor 482 Zeilen, TerminBerechnungUtils 502 Zeilen)
- **Migrations-Code** der nach Abschluss toter Code ist

**Keine kritischen Kompatibilitätsprobleme.** minSdk 24, targetSdk 34, compileSdk 34 sind aktuell.

---

## 2. Activities & Navigation

### 2.1 Befund: 24 Activities – Inkonsistentes Setup


| Problem                                                      | Betroffene Activities                                                                                                                                                                                               | Empfehlung                                          |
| ------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| **Kein MaterialTheme-Wrapper**                               | `MainActivity`, `PreiseActivity`, `ErfassungMenuActivity`, `SettingsActivity`, `DataImportActivity`, `TourPlannerActivity`, `CustomerManagerActivity` (~38%)                                                        | Einheitlich `MaterialTheme { }` in allen Activities |
| **window.decorView.setBackgroundColor()**                    | `MainActivity:66`, `AddCustomerActivity:36`                                                                                                                                                                         | Entfernen – über Compose-Theme lösen                |
| **Gemischte Navigation** (AppNavigation vs. direkter Intent) | `PreiseActivity`, `ErfassungMenuActivity`, `BelegeActivity`, `KundenListenActivity`, `DataImportActivity`, `TourPlannerActivity`, `CustomerDetailActivity`, `CustomerManagerActivity`, `AddCustomerActivity` (~62%) | Alle auf `AppNavigation` umstellen                  |
| **Kein BackHandler**                                         | ~22 von 24 Activities                                                                                                                                                                                               | Für komplexe State-Machines BackHandler ergänzen    |
| **Intent-Extra-Boilerplate**                                 | `CustomerDetailActivity:59`, `AusnahmeTerminActivity:55`, `TerminAnlegenUnregelmaessigActivity:44`, `ListeBearbeitenActivity:29`, `UrlaubActivity:28`                                                               | Extension-Funktion `Intent.requireStringExtra(key)` |
| **@Suppress("UNUSED_EXPRESSION")** Workaround                | `StatisticsActivity:37`, `ListeErstellenActivity:20`                                                                                                                                                                | Koin-Initialisierung korrekt lösen                  |


### 2.2 Empfehlung: Base-Activity oder Compose-Wrapper

```kotlin
// Vorschlag: AppThemeWrapper.kt
@Composable
fun AppThemeWrapper(content: @Composable () -> Unit) {
    MaterialTheme(
        colorScheme = AppColorScheme,
        typography = AppTypography
    ) { content() }
}
```

Alle `setContent { }` einheitlich:

```kotlin
setContent { AppThemeWrapper { ScreenContent(...) } }
```

---

## 3. UI/Design-System

### 3.1 Farben – Inkonsistenz


| Problem                         | Stellen                                                                                          | Wert                                      |
| ------------------------------- | ------------------------------------------------------------------------------------------------ | ----------------------------------------- |
| Hardcodiert `Color.White`       | `MainScreen:158, 279`                                                                            | → `colorResource(R.color.white)`          |
| Hardcodiert `Color(0xFFE0E0E0)` | `CustomerDetailStammdatenTab:87`, `ListeBearbeitenMetadatenBlock:46`, `ListeErstellenScreen:212` | → `colorResource(R.color.light_gray)`     |
| Hardcodiert `Color(0xFFFFEB3B)` | `TourPlannerTopBar:159, 164`                                                                     | → `colorResource(R.color.offline_yellow)` |
| Hardcodiert `Color(0xFF388E3C)` | `TourPlannerCustomerRow:47`                                                                      | → `colorResource(R.color.status_done)`    |
| Hardcodiert `Color(0xFFF5F5F5)` | `UrlaubWindowContent:81, 93`                                                                     | → `colorResource(R.color.surface_light)`  |
| Doppelte Farben in `colors.xml` | `status_overdue` = `error_red` = `#D32F2F`; `status_done` = `button_auslieferung` = `#388E3C`    | Konsolidieren                             |
| Veraltete Farbe                 | `purple_500` ("alte Primärfarbe")                                                                | Prüfen und entfernen                      |


### 3.2 Typografie – Kein einheitliches System


| Verwendung    | Werte (verstreut)           | Empfohlener Standard   |
| ------------- | --------------------------- | ---------------------- |
| Titel groß    | `28.sp` (MainScreen)        | `TitleLarge = 28.sp`   |
| Titel mittel  | `20.sp` (diverse Screens)   | `TitleMedium = 20.sp`  |
| Titel klein   | `18.sp` (TourListeCardRow)  | `TitleSmall = 18.sp`   |
| Section-Titel | `16.sp` (DetailUiConstants) | `SectionTitle = 16.sp` |
| Body          | `14.sp` (DetailUiConstants) | `Body = 14.sp`         |
| Button-Text   | `14-17.sp` (inkonsistent!)  | `ButtonText = 16.sp`   |
| Caption       | `12.sp` (diverse)           | `Caption = 12.sp`      |
| Small         | `10.sp` (diverse)           | `Small = 10.sp`        |


`**DetailUiConstants**` existiert, wird aber nur in ~3 Screens genutzt. Alle anderen Screens verwenden eigene Werte.

### 3.3 Spacing – Inkonsistenz


| Verwendung      | Werte (verstreut)              | Empfohlener Standard     |
| --------------- | ------------------------------ | ------------------------ |
| Screen-Padding  | `16dp`, `20dp`, `24dp`, `32dp` | `ScreenPadding = 16.dp`  |
| Card-Padding    | `12dp`, `16dp`, `20dp`         | `CardPadding = 16.dp`    |
| Feld-Abstand    | `8dp`, `12dp`, `16dp`          | `FieldSpacing = 12.dp`   |
| Section-Abstand | `16dp`, `20dp`, `24dp`, `28dp` | `SectionSpacing = 20.dp` |


### 3.4 Buttons – Inkonsistenz


| Eigenschaft      | Werte (verstreut)             | Empfohlener Standard      |
| ---------------- | ----------------------------- | ------------------------- |
| Höhe (Primary)   | `48dp`, `56dp`, `72dp`        | `PrimaryHeight = 48.dp`   |
| Höhe (Secondary) | `44dp`, `48dp`, `64dp`        | `SecondaryHeight = 44.dp` |
| Corner-Radius    | `8dp`, `12dp`, `16dp`, `20dp` | `CornerRadius = 12.dp`    |


### 3.5 Empfehlung: Zentrales Design-System

Neue Dateien erstellen:

```
ui/theme/
  ├── AppTheme.kt          // MaterialTheme-Wrapper + ColorScheme
  ├── AppColors.kt         // Alle Farb-Konstanten
  ├── AppTypography.kt     // Typography-System
  ├── AppSpacing.kt        // Spacing-Konstanten
  ├── AppButtonStyles.kt   // Button-Konfigurationen
  └── AppComponents.kt     // Wiederverwendbare Composables
```

### 3.6 Fehlende wiederverwendbare Composables


| Composable          | Beschreibung                                    | Nutzer-Screens      |
| ------------------- | ----------------------------------------------- | ------------------- |
| `AppTopBar`         | Standard-TopBar mit Back-Button, Titel, Actions | Alle Screens        |
| `AppLoadingView`    | Einheitlicher Lade-Indikator                    | Alle Screens        |
| `AppErrorView`      | Fehlermeldung mit Retry-Button                  | Alle Screens        |
| `AppEmptyView`      | Leerzustands-Anzeige                            | Alle Listen-Screens |
| `AppPrimaryButton`  | Primärer Button (einheitlich)                   | Alle Screens        |
| `AppOutlinedButton` | Outlined Button (einheitlich)                   | Diverse Screens     |
| `AppCard`           | Standard-Card mit Padding/Elevation             | Diverse Screens     |
| `AppTextField`      | Standard-Textfeld                               | Formulare           |
| `AppBadge`          | Status-Badges (A, L, Überfällig usw.)           | Tour, Kunden        |
| `AppSectionHeader`  | Section-Überschrift                             | Detail, Listen      |


**Aktuell:** Jeder Screen hat eigene Loading/Error/Empty-Views:

- `TourPlannerLoadingView`, `TourPlannerErrorView`, `TourPlannerEmptyView`
- `ListeBearbeitenLoadingView`
- `KundenListenScreen`: Inline `Text` mit Emoji
- `StatisticsScreen`: Einfacher `Text`

---

## 4. ViewModels & State Management

### 4.1 Gemischte Patterns (LiveData vs. StateFlow)


| ViewModel                         | Pattern                                  | Empfehlung                       |
| --------------------------------- | ---------------------------------------- | -------------------------------- |
| `MainViewModel` (in MainActivity) | `LiveData` + `observeAsState`            | → `StateFlow` + `collectAsState` |
| `TourPlannerViewModel`            | `StateFlow` intern, `LiveData` exponiert | → `StateFlow` durchgängig        |
| `AddCustomerViewModel`            | Nur `LiveData`                           | → `StateFlow`                    |
| `CustomerManagerViewModel`        | Gemischt (LiveData + StateFlow)          | → `StateFlow` durchgängig        |
| `MapViewModel`                    | `LiveData`                               | → `StateFlow`                    |
| `StatisticsViewModel`             | `LiveData`                               | → `StateFlow`                    |
| `ListeErstellenViewModel`         | `LiveData`                               | → `StateFlow`                    |
| `CustomerDetailViewModel`         | `StateFlow`                              | ✅ OK                             |
| `WaschenErfassungViewModel`       | `StateFlow`                              | ✅ OK                             |
| `BelegeViewModel`                 | `StateFlow`                              | ✅ OK                             |
| `KundenListenViewModel`           | `StateFlow`                              | ✅ OK                             |
| `ListeBearbeitenViewModel`        | `StateFlow`                              | ✅ OK                             |


**~7 ViewModels (29%) nutzen noch LiveData** – Migration zu StateFlow empfohlen.

### 4.2 Error-Handling in ViewModels – inkonsistent


| ViewModel                   | Error-Pattern                        |
| --------------------------- | ------------------------------------ |
| `CustomerDetailViewModel`   | `_errorMessage: StateFlow<String?>`  |
| `CustomerManagerViewModel`  | `_error: LiveData<String?>`          |
| `WaschenErfassungViewModel` | Error in `UiState` sealed class      |
| `ListeBearbeitenViewModel`  | `when (result)` mit eigenem Handling |


**Empfehlung:** Einheitliches Error-Handling über BaseViewModel:

```kotlin
abstract class BaseViewModel : ViewModel() {
    protected val _errorMessage = MutableStateFlow<String?>(null)
    val errorMessage: StateFlow<String?> = _errorMessage
    
    protected fun <T> handleResult(
        result: Result<T>,
        onSuccess: (T) -> Unit
    ) { ... }
}
```

### 4.3 Stille Fehler (Silent Returns)


| Stelle                                   | Problem                                              |
| ---------------------------------------- | ---------------------------------------------------- |
| `CustomerDetailViewModel.saveCustomer()` | `_customerId.value ?: return` – kein Fehler-Feedback |
| `ListeBearbeitenViewModel.loadDaten()`   | `listeId ?: return` – kein Fehler-Feedback           |


**Empfehlung:** Statt `return` einen Error-State emittieren.

---

## 5. Repositories & Datenzugriff

### 5.1 Inkonsistenzen


| Problem                                        | Stellen                                                                                                      | Empfehlung                           |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | ------------------------------------ |
| **Rückgabetyp-Mix:** `Boolean` vs. `Result<T>` | `CustomerRepository.updateCustomer()` vs. `updateCustomerResult()`                                           | Alle auf `Result<T>` standardisieren |
| **Retry-Logik inkonsistent**                   | `CustomerRepository`: nutzt `FirebaseRetryHelper`; `ErfassungRepository`, `ArticleRepository`: nur try-catch | `FirebaseRetryHelper` überall        |
| **Parsing-Pattern inkonsistent**               | `CustomerSnapshotParser`: separate Klasse; `KundenListeRepository`, `ErfassungRepository`: inline            | Eigene Parser-Klassen extrahieren    |
| **AppErrorMapper inkonsistent**                | Nur in `CustomerRepository.deleteAllSevDeskContacts()` genutzt                                               | Überall in Repositories verwenden    |


### 5.2 Empfehlung: Basis-Repository

```kotlin
abstract class BaseRepository {
    protected suspend fun <T> withRetry(
        operation: suspend () -> T
    ): Result<T> = FirebaseRetryHelper.withRetry(operation)
    
    protected fun mapError(e: Exception): String = 
        AppErrorMapper.map(e)
}
```

---

## 6. Datenmodelle

### 6.1 Befund

- **Nullable-Felder:** Konsistent und korrekt (`latitude: Double?`, `tageAzuL: Int?`)
- **Default-Werte:** Sinnvoll (`emptyList()`, `0L`, `""`)
- **Firebase-Serialisierung:** Korrekt mit Type-Handling (Long als Double)

### 6.2 Fehlende Validierung


| Modell     | Feld            | Problem                         |
| ---------- | --------------- | ------------------------------- |
| `Customer` | `tageAzuL`      | Keine Range-Validierung (0–365) |
| `Customer` | `intervallTage` | Keine Range-Validierung (1–365) |


**Empfehlung:** Validierungsfunktionen in Datenmodelle einbauen:

```kotlin
fun Customer.validate(): ValidationResult
```

---

## 7. Business-Logik & Utils

### 7.1 Zu große Dateien


| Datei                         | Zeilen | Problem                                             | Empfehlung                                                  |
| ----------------------------- | ------ | --------------------------------------------------- | ----------------------------------------------------------- |
| `TourDataProcessor.kt`        | 482    | Tiefe Verschachtelung, mehrere Verantwortlichkeiten | Aufteilen in: `TourErledigtDetector`, `TourOverdueDetector` |
| `TerminBerechnungUtils.kt`    | 502    | Mischung aus Berechnungen, Filterung, Datums-Ops    | Aufteilen in: `TerminCalculationUtils`, `TerminDateUtils`   |
| `ListeBearbeitenCallbacks.kt` | 364    | Gut strukturiert, aber grenzwertig                  | Optional: `ListeCustomerOps`, `ListeTerminOps`              |
| `SevDeskApi.kt`               | 466    | Gut strukturiert                                    | OK – API-Klassen sind naturgemäß groß                       |


### 7.2 Migrations-Code


| Datei                                    | Zeilen | Status                                             |
| ---------------------------------------- | ------ | -------------------------------------------------- |
| `ListeToTourMigration.kt`                | 32     | Läuft bei jedem Start (Early-Return wenn erledigt) |
| `TourToListenkundenMigration.kt`         | 32     | Gleich                                             |
| `ListeArtTourToListenkundenMigration.kt` | 30     | Gleich                                             |
| `ListeArtToTourMigration.kt`             | 32     | Gleich                                             |
| `ListenPrivatKundenpreiseMigration.kt`   | 46     | Gleich                                             |
| `ListeIntervalleMigration.kt`            | 84     | Referenziert veraltete Felder                      |
| `RemoveDeprecatedFieldsMigration.kt`     | 53     | Prüft veraltete Felder                             |


**Empfehlung:** Nach Abschluss aller Migrationen in `legacy/`-Package verschieben oder entfernen.

### 7.3 FirebaseSyncManager – No-Op

`FirebaseSyncManager.kt`: Alle Methoden sind No-Ops (leere Implementierungen). Kommentare erklären, dass Firebase RTDB Sync automatisch macht.

**Empfehlung:** Entweder entfernen oder als Dokumentation beibehalten mit `@Deprecated`-Annotation.

### 7.4 AppLogger – Hardcoded Flag

`AppLogger.kt:28`: `private const val ENABLED = true`  
**Empfehlung:** `BuildConfig.DEBUG` verwenden.

---

## 8. Doppelter Code (Duplikate)

### 8.1 Hohe Priorität


| Duplikat                                  | Stellen                                                                 | Lösung                              |
| ----------------------------------------- | ----------------------------------------------------------------------- | ----------------------------------- |
| **Result-Handling** in ViewModels         | `CustomerDetailVM:197`, `CustomerManagerVM:188`, `ListeBearbeitenVM:84` | Extension-Funktion `handleResult()` |
| **Kunden-Suche** (Cache + Filter)         | `WaschenErfassungVM:180-200`, `BelegeVM:140-151`                        | `CustomerSearchHelper`-Klasse       |
| **Preis-Laden** (Kundenpreise → Fallback) | `WaschenErfassungVM:238-247`, `BelegeVM:211-220`                        | `PriceLoadingUtils`-Klasse          |
| **Erfassung-Flow-Collection**             | `WaschenErfassungVM:207-216`, `BelegeVM:168-177`                        | `ErfassungFlowCollector`-Klasse     |


### 8.2 Mittlere Priorität


| Duplikat                                            | Stellen                                                                  | Lösung                               |
| --------------------------------------------------- | ------------------------------------------------------------------------ | ------------------------------------ |
| **Loading-State** (`_isLoading = MutableStateFlow`) | 6+ ViewModels                                                            | BaseViewModel                        |
| **Überfällig-Erkennung**                            | `TourDataProcessor:427`, `TourDataFilter:79`, `TerminFilterUtils:70, 99` | Konsolidieren in `TerminFilterUtils` |
| **Erledigt-Erkennung**                              | Mehrfach in `TourDataProcessor`, `TourListenProcessorImpl`               | Eigene Klasse `ErledigtDetector`     |
| **getStartOfDay()**                                 | `TerminBerechnungUtils:25`, `TourDataCategorizer` (ähnlich)              | Einmal in `AppTimeZone`              |


### 8.3 Niedrige Priorität


| Duplikat                 | Stellen                                                         | Lösung                                    |
| ------------------------ | --------------------------------------------------------------- | ----------------------------------------- |
| **BelegMonat-Grouping**  | `CustomerDetailVM:103`, `WaschenErfassungVM:118`, `BelegeVM:93` | Bereits extrahiert – nur 1-Zeiler-Aufrufe |
| **Intent-Extra-Reading** | 5+ Activities                                                   | Extension-Funktion                        |
| **Toast-Fehler-Anzeige** | Diverse Activities                                              | Extension-Funktion `showToast()`          |


---

## 9. Zentralisierungspotenzial

### 9.1 Sofort umsetzbar (Quick Wins)


| Was                                          | Wie                                                 | Aufwand |
| -------------------------------------------- | --------------------------------------------------- | ------- |
| **AppThemeWrapper**                          | Compose-Wrapper für einheitliches MaterialTheme     | Klein   |
| **AppColors-Objekt**                         | Typ-sichere Farb-Konstanten statt `colorResource()` | Klein   |
| **AppSpacing-Objekt**                        | Spacing-Konstanten                                  | Klein   |
| **AppTypography-Objekt**                     | Typografie-System                                   | Klein   |
| **Extension: `Intent.requireStringExtra()**` | Reduziert Boilerplate in 5+ Activities              | Klein   |
| **Extension: `Context.showToast()**`         | Reduziert Boilerplate                               | Klein   |


### 9.2 Mittelfristig


| Was                                              | Wie                                                  | Aufwand |
| ------------------------------------------------ | ---------------------------------------------------- | ------- |
| **AppTopBar-Composable**                         | Einheitliche TopBar für alle Screens                 | Mittel  |
| **AppLoadingView / AppErrorView / AppEmptyView** | 3 Composables für Zustände                           | Mittel  |
| **AppButton-Varianten**                          | `PrimaryButton`, `SecondaryButton`, `OutlinedButton` | Mittel  |
| **BaseViewModel erweitern**                      | `isLoading`, `errorMessage`, `handleResult()`        | Mittel  |
| **CustomerSearchHelper**                         | Kunden-Suche zentralisieren                          | Mittel  |
| **PriceLoadingUtils**                            | Preis-Laden zentralisieren                           | Mittel  |
| **Navigation: Alle auf AppNavigation**           | Direkte Intents ersetzen                             | Mittel  |


### 9.3 Langfristig


| Was                                 | Wie                                          | Aufwand |
| ----------------------------------- | -------------------------------------------- | ------- |
| **LiveData → StateFlow Migration**  | 7 ViewModels umstellen                       | Groß    |
| **TourDataProcessor aufteilen**     | 482-Zeilen-Datei refactoren                  | Groß    |
| **TerminBerechnungUtils aufteilen** | 502-Zeilen-Datei refactoren                  | Groß    |
| **Repository-Standardisierung**     | Alle auf `Result<T>` + `FirebaseRetryHelper` | Groß    |
| **Migrations-Code aufräumen**       | Prüfen und archivieren/entfernen             | Mittel  |


---

## 10. Kompatibilität & Dependencies

### 10.1 SDK-Level


| Eigenschaft  | Wert             | Status                       |
| ------------ | ---------------- | ---------------------------- |
| `minSdk`     | 24 (Android 7.0) | ✅ OK – ~95% Geräte-Abdeckung |
| `targetSdk`  | 34 (Android 14)  | ✅ Aktuell                    |
| `compileSdk` | 34               | ✅ Aktuell                    |


**Keine Kompatibilitätsprobleme festgestellt.** Alle verwendeten APIs sind mit minSdk 24 kompatibel.

### 10.2 Dependencies – Aktualisierungsbedarf prüfen


| Dependency       | Aktuelle Version | Prüfen                    |
| ---------------- | ---------------- | ------------------------- |
| Compose BOM      | `2024.02.00`     | Neuere Version verfügbar? |
| Lifecycle        | `2.7.0`          | Neuere Version verfügbar? |
| Activity Compose | `1.8.2`          | Neuere Version verfügbar? |
| Koin             | `3.5.0`          | Neuere Version verfügbar? |
| Firebase BOM     | `33.1.2`         | Neuere Version verfügbar? |
| AGP              | `9.0.0`          | ✅ Aktuell                 |
| Kotlin           | `2.0.21`         | ✅ Aktuell                 |


### 10.3 Berechtigungen


| Berechtigung                                | Status                    |
| ------------------------------------------- | ------------------------- |
| `INTERNET`                                  | ✅ OK                      |
| `CAMERA`                                    | ✅ OK                      |
| `WRITE_EXTERNAL_STORAGE` (maxSdkVersion 32) | ✅ Korrekt für Android 13+ |
| FileProvider für Fotos                      | ✅ OK                      |
| `queries` für Google Maps                   | ✅ OK                      |


### 10.4 Predictive Back

`enableOnBackInvokedCallback="true"` ist gesetzt – ✅ korrekt für Android 13+.

---

## 11. Bekannte Konflikte

### 11.1 Architektur-Konflikte


| Konflikt                                     | Beschreibung                                                                         |
| -------------------------------------------- | ------------------------------------------------------------------------------------ |
| **LiveData vs. StateFlow**                   | 29% ViewModels nutzen LiveData, 71% StateFlow – gemischte Architektur                |
| **AppNavigation vs. direkte Intents**        | 21% nutzen AppNavigation, 62% direkte Intents – Navigationssystem nicht durchgesetzt |
| **MaterialTheme: mit vs. ohne**              | 62% der Activities haben MaterialTheme-Wrapper, 38% nicht                            |
| **DetailUiConstants: genutzt vs. ignoriert** | Nur ~3 Screens nutzen es, Rest hat eigene Werte                                      |


### 11.2 Logik-Konflikte


| Konflikt                                  | Beschreibung                                                                                     |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------ |
| **Überfällig-Erkennung** an 3+ Stellen    | `TourDataProcessor`, `TourDataFilter`, `TerminFilterUtils` – potenziell divergierendes Verhalten |
| **Repository-Return: Boolean vs. Result** | `updateCustomer()` gibt `Boolean`, `updateCustomerResult()` gibt `Result<Boolean>` – verwirrend  |


---

## 12. Toter/Alter Code


| Datei/Code                                                                                                                                         | Problem                                                              | Empfehlung                                 |
| -------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- | ------------------------------------------ |
| **7 Migrations-Dateien** (`util/*Migration.kt`)                                                                                                    | Laufen bei jedem Start, Early-Return nach Abschluss                  | Prüfen ob erledigt → archivieren/entfernen |
| **FirebaseSyncManager.kt**                                                                                                                         | Alle Methoden sind No-Ops                                            | Entfernen oder `@Deprecated`               |
| `**purple_500**` in `colors.xml`                                                                                                                   | "Alte Primärfarbe" – wahrscheinlich ungenutzt                        | Prüfen und entfernen                       |
| **Alte Struktur-Support** in `TerminBerechnungUtils`                                                                                               | Kommentare erwähnen "alte Struktur"                                  | Nach Migration entfernen                   |
| `**RemoveDeprecatedFieldsMigration**`                                                                                                              | Referenziert veraltete Felder (`abholungDatum`, `auslieferungDatum`) | Prüfen und entfernen                       |
| `**TabSwipeFrameLayout.kt**`                                                                                                                       | Custom View – prüfen ob noch in Compose-Welt genutzt                 | Prüfen, ggf. entfernen                     |
| **View-basierte Dialoge** (`TourPlannerDialogHelper`)                                                                                              | Nutzt `AlertDialog.Builder` statt Compose                            | Zu Compose-Dialogen migrieren              |
| **Diverse Layout-XMLs** (`item_week_day.xml`, `dialog_termin_detail.xml`, `item_kunde_liste.xml`, `item_photo.xml`, `dialog_fullscreen_image.xml`) | View-basierte Layouts – prüfen ob noch genutzt                       | Referenzen prüfen, ggf. entfernen          |


---

## 13. Accessibility


| Problem                         | Stellen                                             | Empfehlung                                   |
| ------------------------------- | --------------------------------------------------- | -------------------------------------------- |
| **Fehlende contentDescription** | `MainScreen:94, 110` (Icons), diverse andere Icons  | Alle Icons mit `contentDescription` versehen |
| **Farbkontrast**                | Text auf farbigen Hintergründen – nicht verifiziert | WCAG AA Kontrast prüfen                      |
| **Touch-Target < 48dp**         | Einige Buttons möglicherweise zu klein              | Minimum `48.dp` sicherstellen                |
| **Hardcoded sp-Werte**          | Überall – funktioniert aber mit System-Skalierung   | Testen mit großer Schrift                    |


---

## 14. Strings & Lokalisierung

### 14.1 Guter Zustand

`strings.xml` hat **866 Zeilen** – umfangreiche Abdeckung.

### 14.2 Hardcodierte Strings im Code


| Datei                               | String                                 | Empfehlung                                     |
| ----------------------------------- | -------------------------------------- | ---------------------------------------------- |
| `CustomerTypeButtonHelper.kt:19-24` | "Gewerblich", "Privat", "Listenkunden" | → String-Ressourcen                            |
| `DialogBaseHelper.kt:21-22`         | "Ja", "Abbrechen"                      | → `R.string.dialog_yes`, `R.string.btn_cancel` |
| `SevDeskApi.kt:21`                  | `CATEGORY_ID_KUNDE = "3"`              | OK – API-Konstante                             |


### 14.3 Potenziell ungenutzte Strings

Einige `tour_preis_*` Strings könnten veraltet sein (umbenannt zu `standard_preis_*`). Prüfung empfohlen.

---

## 15. Ressourcen (Drawables, Colors, Themes)

### 15.1 Drawables – Gut organisiert

- Einheitliche Benennung: `button_*_glossy.xml`, `status_badge_*.xml`, `ic_*.xml`
- Keine Probleme gefunden

### 15.2 Colors – Doppelte Einträge


| Farbe 1          | Farbe 2               | Wert                  | Aktion                      |
| ---------------- | --------------------- | --------------------- | --------------------------- |
| `status_overdue` | `error_red`           | `#D32F2F`             | Konsolidieren               |
| `status_done`    | `button_auslieferung` | `#388E3C`             | Konsolidieren               |
| `primary_blue`   | `button_blue`         | `#1976D2` / `#2196F3` | Klären: gleiche Verwendung? |


### 15.3 Themes – Gut

- Material Design 3 korrekt eingesetzt
- Mehrere Theme-Varianten vorhanden
- Keine Probleme

### 15.4 View-basierte Layouts

5 Layout-XMLs existieren noch (siehe Abschnitt 12). Prüfen ob diese noch von aktiven Activities/Fragments genutzt werden oder nach der Compose-Migration entfernbar sind.

---

## 16. Positiv-Befunde


| Bereich               | Befund                                                            |
| --------------------- | ----------------------------------------------------------------- |
| **Architektur**       | Klare Trennung: Activities → ViewModels → Repositories → Firebase |
| **Koin DI**           | Konsistente Injection in allen Activities und ViewModels          |
| **Firebase**          | Korrekte Offline-Persistence, Retry-Logik, Coroutines             |
| **Compose-Migration** | Abgeschlossen – alle Screens sind Compose                         |
| **String-Ressourcen** | Umfangreiche `strings.xml` mit 866 Zeilen                         |
| **Error-Retry**       | `FirebaseRetryHelper` gut implementiert                           |
| **Daten-Parsing**     | `CustomerSnapshotParser` als saubere Abstraktion                  |
| **Package-Struktur**  | Logisch organisiert (ui, data, tourplanner, util, wasch)          |
| **Manifest**          | Alle 24 Activities korrekt registriert, `exported=false`          |
| **Berechtigungen**    | Korrekt, keine überflüssigen                                      |
| **Migrations**        | Sauber mit SharedPreferences-Flags                                |


---

## 17. Priorisierter Maßnahmenplan

### Phase 1: Quick Wins & Zentralisierung (1–2 Wochen)

- **P1-01** `AppTheme.kt` erstellen: MaterialTheme-Wrapper mit ColorScheme + Typography
- **P1-02** `AppColors.kt` erstellen: Farb-Konstanten zentralisieren
- **P1-03** `AppTypography.kt` erstellen: Typografie-System
- **P1-04** `AppSpacing.kt` erstellen: Spacing-Konstanten
- **P1-05** Alle hardcodierten Farben ersetzen (~10 Stellen)
- **P1-06** MaterialTheme-Wrapper in alle Activities einbauen (~9 Activities)
- **P1-07** Extension `Intent.requireStringExtra()` erstellen
- **P1-08** Extension `Context.showToast()` erstellen
- **P1-09** `AppLogger`: `BuildConfig.DEBUG` statt hardcoded `true`
- **P1-10** Hardcodierte Strings in `CustomerTypeButtonHelper`, `DialogBaseHelper` ersetzen

### Phase 2: Wiederverwendbare Composables (2–3 Wochen)

- **P2-01** `AppTopBar`-Composable erstellen und in alle Screens einbauen
- **P2-02** `AppLoadingView`, `AppErrorView`, `AppEmptyView` erstellen
- **P2-03** `AppPrimaryButton`, `AppSecondaryButton` erstellen
- **P2-04** `AppCard`-Composable erstellen
- **P2-05** Alle Screens auf neue Composables umstellen
- **P2-06** Doppelte Farben in `colors.xml` konsolidieren
- **P2-07** Ungenutzte Farben (`purple_500`) entfernen

### Phase 3: ViewModel-Refactoring (2–3 Wochen)

- **P3-01** `BaseViewModel` erweitern: `isLoading`, `errorMessage`, `handleResult()`
- **P3-02** `CustomerSearchHelper` extrahieren (aus WaschenErfassungVM + BelegeVM)
- **P3-03** `PriceLoadingUtils` extrahieren
- **P3-04** `ErfassungFlowCollector` extrahieren
- **P3-05** Stille `return`s durch Error-States ersetzen
- **P3-06** `AppErrorMapper` überall einsetzen

### Phase 4: Navigation & LiveData-Migration (2–3 Wochen)

- **P4-01** Alle direkten Intents auf `AppNavigation` umstellen (~15 Activities)
- **P4-02** LiveData → StateFlow Migration: `AddCustomerViewModel`
- **P4-03** LiveData → StateFlow Migration: `TourPlannerViewModel`
- **P4-04** LiveData → StateFlow Migration: `CustomerManagerViewModel`
- **P4-05** LiveData → StateFlow Migration: `MainViewModel` (in MainActivity)
- **P4-06** LiveData → StateFlow Migration: `StatisticsViewModel`, `MapViewModel`, `ListeErstellenViewModel`

### Phase 5: Repository & Business-Logik (2–3 Wochen)

- **P5-01** Repository-Return-Typen standardisieren (`Result<T>`)
- **P5-02** `FirebaseRetryHelper` in allen Repositories einsetzen
- **P5-03** Parser in separate Klassen extrahieren (`ErfassungSnapshotParser`, `KundenListeSnapshotParser`)
- **P5-04** `TourDataProcessor` aufteilen (482 → 2–3 Dateien à 150–250 Zeilen)
- **P5-05** `TerminBerechnungUtils` aufteilen (502 → 2 Dateien)
- **P5-06** Überfällig-Erkennung konsolidieren (1 Single Source of Truth)

### Phase 6: Aufräumen (1–2 Wochen)

- **P6-01** Migrations-Code prüfen: erledigt? → archivieren/entfernen
- **P6-02** `FirebaseSyncManager` (No-Op) entfernen oder `@Deprecated`
- **P6-03** View-basierte Layouts prüfen und ggf. entfernen
- **P6-04** `TourPlannerDialogHelper` zu Compose-Dialogen migrieren
- **P6-05** `TabSwipeFrameLayout` prüfen und ggf. entfernen
- **P6-06** Ungenutzte Strings prüfen und bereinigen
- **P6-07** Accessibility: contentDescription zu allen Icons hinzufügen
- **P6-08** Dependencies auf neueste Versionen aktualisieren (Compose BOM, Lifecycle, Koin, Firebase)
- **P6-09** Datenmodell-Validierung einbauen (`Customer.validate()`)

---

## Zusammenfassung


| Kategorie               | Befund-Anzahl | Kritisch | Mittel | Niedrig |
| ----------------------- | ------------- | -------- | ------ | ------- |
| Activities & Navigation | 6             | 2        | 3      | 1       |
| UI/Design-System        | 10            | 3        | 5      | 2       |
| ViewModels & State      | 6             | 2        | 3      | 1       |
| Repositories            | 4             | 1        | 2      | 1       |
| Business-Logik          | 5             | 2        | 2      | 1       |
| Doppelter Code          | 10            | 4        | 4      | 2       |
| Zentralisierung         | 13            | 6        | 4      | 3       |
| Kompatibilität          | 2             | 0        | 1      | 1       |
| Toter Code              | 8             | 1        | 4      | 3       |
| Accessibility           | 4             | 0        | 2      | 2       |
| **Gesamt**              | **68**        | **21**   | **30** | **17**  |


**Geschätzter Gesamtaufwand:** 10–16 Wochen (bei schrittweiser Umsetzung)

---

*Dieser Plan dient als Referenz. Keine Änderung ohne ausdrückliche Freigabe (vgl. `.cursor/rules/nicht-kaputt-machen.mdc`).*