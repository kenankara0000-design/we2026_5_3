# Plan: Mehrere wöchentliche Intervalle pro Kunde

## Ziel
Nutzer sollen über die UI **mehrere wöchentliche Intervalle** pro Kunde hinzufügen können (z.B. DI A→SO L + SO A→DI L).

## Kernidee
- Neuer Menüpunkt "Wöchentlich" im "+ Termin"-Menü
- Bottom Sheet zum Anlegen: A-Wochentag, L-Wochentag, Intervall-Tage wählen
- Zusätzliche Intervalle als Liste im Edit-Modus anzeigen (mit Löschen-Button)
- `buildSavePayload`-Filter erweitern, damit manuell angelegte Weekly-Intervalle beim Speichern nicht verloren gehen

---

## Dateien

### 1. NEUE DATEI: `AddWeeklyIntervallSheet.kt`
**Pfad:** `ui/detail/AddWeeklyIntervallSheet.kt`

Bottom Sheet (analog zu `AddMonthlyIntervallSheet.kt`):
- A-Wochentag: `WochentagChipRowFromResources` (Single-Select, 0–6)
- L-Wochentag: `WochentagChipRowFromResources` (Single-Select, 0–6)
- Intervall-Tage: Chips (7, 14, 21, 28) oder Freitext via `AddCustomerIntervallSchnellauswahl`
- "Hinzufügen"-Button erstellt ein `CustomerIntervall`:
  - `abholungDatum` = nächster A-Wochentag ab heute (`WochentagBerechnung.naechsterWochentagAb`)
  - `auslieferungDatum` = `abholungDatum` + Tage bis L-Wochentag (`tageAzuLBetween`)
  - `intervallTage` = gewählter Wert
  - `wiederholen = true`
  - `regelTyp = WEEKLY`
  - `terminRegelId = "manual-weekly"` (Marker, damit buildSavePayload es nicht filtert)

### 2. `NeuerTerminArtSheet.kt`
- Enum `NeuerTerminArt`: neuen Wert `WOECHENTLICH` hinzufügen
- `allowedArtsFor`: `WOECHENTLICH` für `REGELMAESSIG`-Kunden erlauben
- Neue Zeile im Sheet mit Farbe (Grün-Blau-Ton) + Beschreibung

### 3. `strings.xml`
Neue Strings:
- `label_termin_art_woechentlich` = "Wöchentlich (A-Tag → L-Tag)"
- `label_termin_art_woechentlich_sub` = "z.B. Di Abholung → So Auslieferung"
- `label_weekly_sheet_title` = "Wöchentliches Intervall"
- `label_abholung_wochentag_waehlen` = "Abholung am:"
- `label_auslieferung_wochentag_waehlen` = "Auslieferung am:"

### 4. `CustomerDetailTermineTab.kt`
Neue Parameter:
- `editIntervalle: List<CustomerIntervall> = emptyList()`
- `onDeleteIntervall: ((Int) -> Unit)? = null`
- `showAddWeeklySheet: Boolean = false`
- `onDismissAddWeeklySheet: () -> Unit = {}`
- `onConfirmAddWeekly: (CustomerIntervall) -> Unit = {}`

Im Edit-Modus nach dem Formular:
- Sektion "Zusätzliche Intervalle" anzeigen, wenn `editIntervalle` manuell angelegte enthält
  (Filter: `terminRegelId.isNotBlank()` ODER `regelTyp == MONTHLY_WEEKDAY`)
- Jedes Intervall als `CustomerDetailIntervallRow` (bereits vorhanden, bisher ungenutzt)
- `AddWeeklyIntervallSheet` einbinden (analog zu `AddMonthlyIntervallSheet`)

### 5. `CustomerDetailScreen.kt`
- Neuen State `showAddWeeklySheet` verwalten
- Bei `NeuerTerminArt.WOECHENTLICH` → `showAddWeeklySheet = true`
- `editIntervalle`, `onDeleteIntervall`, Weekly-Sheet-Params an `CustomerDetailTermineTab` durchreichen
- `onConfirmAddWeekly` → `onAddMonthlyIntervall?.invoke(it)` (Funktion ist generisch)

### 6. `CustomerDetailViewModel.kt` → `buildSavePayload`
**Zeile 285 ändern** – Der Filter für zusätzliche Intervalle:
```
// ALT:
val fromRules = editIntervalle.filter { it.terminRegelId.isNotBlank() || it.regelTyp == TerminRegelTyp.MONTHLY_WEEKDAY }

// NEU:
val fromRules = editIntervalle.filter { it.terminRegelId.isNotBlank() || it.regelTyp == TerminRegelTyp.MONTHLY_WEEKDAY }
```
Keine Code-Änderung nötig! Da `terminRegelId = "manual-weekly"` (nicht blank) wird das manuell angelegte Intervall automatisch von `terminRegelId.isNotBlank()` erfasst.

### 7. `CustomerDetailActivity.kt`
Keine Änderung nötig – `onAddMonthlyIntervall` wird bereits generisch verwendet (fügt einfach ein Intervall zur Liste hinzu). Die Funktion heißt zwar "Monthly", akzeptiert aber jedes `CustomerIntervall`.

---

## Datenfluss

```
User klickt "+ Termin" → "Wöchentlich"
  → AddWeeklyIntervallSheet öffnet sich
  → User wählt: A=DI, L=SO, Intervall=7
  → Sheet erstellt CustomerIntervall(terminRegelId="manual-weekly", regelTyp=WEEKLY, ...)
  → onConfirmAddWeekly → viewModel.addMonthlyIntervall(intervall)
  → _editIntervalle += neues Intervall
  → TermineTab zeigt es in der Intervall-Liste an

User klickt "Speichern"
  → buildSavePayload:
    → mainFromForm = Intervalle aus Formular (A-Tag, Intervall, etc.)
    → fromRules = editIntervalle.filter { terminRegelId.isNotBlank() || MONTHLY_WEEKDAY }
      → "manual-weekly" hat terminRegelId.isNotBlank() = true ✓
    → Gesamt: mainFromForm + fromRules (kein Duplikat)
```

---

## Nicht betroffen / keine Änderung
- `TourPlannerDragDrop.kt` – bereits gelöscht
- `CustomerDetailActivity.kt` – `onAddMonthlyIntervall` bleibt generisch
- `CustomerDetailViewModel.addMonthlyIntervall` – bleibt, funktioniert für alle Typen
- Bestehende Intervall-Logik (TerminCalculator, Tourenplaner) – keine Änderung
